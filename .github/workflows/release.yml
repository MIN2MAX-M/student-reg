name: Release (Promote)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write
  id-token: write

env:
  IMAGE_REPO: "ghcr.io/MIN2MAX-M/student-reg"

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Determine version + target env
        id: meta
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"     # e.g. v1.2.0 or v1.2.0-rc1
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "image=${{ env.IMAGE_REPO }}" >> $GITHUB_OUTPUT

          if [[ "$TAG" == *"-rc"* ]]; then
            echo "overlay=staging" >> $GITHUB_OUTPUT
            echo "tags=${{ env.IMAGE_REPO }}:${TAG}" >> $GITHUB_OUTPUT
          else
            echo "overlay=prod" >> $GITHUB_OUTPUT
            echo "tags=${{ env.IMAGE_REPO }}:${TAG},${{ env.IMAGE_REPO }}:latest" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push (multi-arch)
        id: buildpush
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.5.0

      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Cosign sign image by digest
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          IMAGE="${{ steps.meta.outputs.image }}@${{ steps.buildpush.outputs.digest }}"
          cosign sign --yes "${IMAGE}"

      - name: Cosign attest SBOM
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          IMAGE="${{ steps.meta.outputs.image }}@${{ steps.buildpush.outputs.digest }}"
          cosign attest --yes --predicate sbom.spdx.json --type spdxjson "${IMAGE}"

      - name: Update GitOps overlay (staging/prod)
        shell: bash
        run: |
          OVERLAY="${{ steps.meta.outputs.overlay }}"
          FILE="k8s/overlays/${OVERLAY}/kustomization.yaml"
          TAG="${{ steps.meta.outputs.tag }}"

          echo "Updating overlay: ${OVERLAY}"
          echo "File: ${FILE}"
          echo "newName -> ${{ steps.meta.outputs.image }}"
          echo "newTag  -> ${TAG}"

          # newName
          if grep -qE "^[[:space:]]*newName:" "$FILE"; then
            sed -i.bak -E "s|^([[:space:]]*newName:).*|\1 ${{ steps.meta.outputs.image }}|" "$FILE"
          fi
          # newTag
          sed -i.bak -E "s|^([[:space:]]*newTag:).*|\1 ${TAG}|" "$FILE"
          rm -f "$FILE.bak"

          grep -nE "newName:|newTag:" "$FILE" || true

      - name: Commit & push overlay update
        run: |
          OVERLAY="${{ steps.meta.outputs.overlay }}"
          TAG="${{ steps.meta.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/overlays/${OVERLAY}/kustomization.yaml
          git commit -m "chore(gitops): promote ${OVERLAY} ${TAG}" || exit 0
          git push
