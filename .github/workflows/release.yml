name: Release (Promote)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Promote tag -> staging/prod
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Determine version + target overlay
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF#refs/tags/}"     # e.g. v1.2.0 or v1.2.0-rc1

          OWNER_LOWER="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          REPO_LOWER="$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')"
          IMAGE="ghcr.io/${OWNER_LOWER}/${REPO_LOWER}"

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"

          if [[ "${TAG}" == *"-rc"* ]]; then
            OVERLAY="staging"
            TAGS="${IMAGE}:${TAG}"
          else
            OVERLAY="prod"
            TAGS="${IMAGE}:${TAG},${IMAGE}:latest"
          fi

          echo "overlay=${OVERLAY}" >> "$GITHUB_OUTPUT"
          echo "tags=${TAGS}" >> "$GITHUB_OUTPUT"

          echo "Resolved:"
          echo "  TAG=${TAG}"
          echo "  IMAGE=${IMAGE}"
          echo "  OVERLAY=${OVERLAY}"
          echo "  TAGS=${TAGS}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build & push (multi-arch)
        id: buildpush
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/student-reg/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.5.0

      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.meta.outputs.tag }}
          path: sbom.spdx.json

      - name: Cosign sign image by digest
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          set -euo pipefail
          IMAGE="${{ steps.meta.outputs.image }}@${{ steps.buildpush.outputs.digest }}"
          cosign sign --yes "${IMAGE}"

      - name: Cosign attest SBOM
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          set -euo pipefail
          IMAGE="${{ steps.meta.outputs.image }}@${{ steps.buildpush.outputs.digest }}"
          cosign attest --yes --predicate sbom.spdx.json --type spdxjson "${IMAGE}"

      - name: Update GitOps overlay (staging/prod)
        shell: bash
        run: |
          set -euo pipefail

          OVERLAY="${{ steps.meta.outputs.overlay }}"
          FILE="apps/student-reg/k8s/overlays/${OVERLAY}/kustomization.yaml"
          TAG="${{ steps.meta.outputs.tag }}"

          echo "Updating overlay: ${OVERLAY}"
          echo "File: ${FILE}"
          echo "newName -> ${{ steps.meta.outputs.image }}"
          echo "newTag  -> ${TAG}"

          if [[ ! -f "$FILE" ]]; then
            echo "ERROR: overlay file not found: $FILE"
            exit 1
          fi

          # Update newName if present (optional)
          if grep -qE "^[[:space:]]*newName:" "$FILE"; then
            sed -i.bak -E "s|^([[:space:]]*newName:).*|\1 ${{ steps.meta.outputs.image }}|" "$FILE"
          fi

          # Update newTag (expected to exist)
          if grep -qE "^[[:space:]]*newTag:" "$FILE"; then
            sed -i.bak -E "s|^([[:space:]]*newTag:).*|\1 ${TAG}|" "$FILE"
          else
            echo "ERROR: newTag not found in $FILE (expected Kustomize images block)."
            echo "Tip: ensure you have something like:"
            echo "images:"
            echo "- name: student-reg"
            echo "  newName: ghcr.io/<owner>/<repo>"
            echo "  newTag: dev"
            exit 1
          fi

          rm -f "$FILE.bak"

          echo "Result:"
          grep -nE "newName:|newTag:" "$FILE" || true

      - name: Commit & push overlay update
        shell: bash
        run: |
          set -euo pipefail

          OVERLAY="${{ steps.meta.outputs.overlay }}"
          TAG="${{ steps.meta.outputs.tag }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "apps/student-reg/k8s/overlays/${OVERLAY}/kustomization.yaml"
          git commit -m "chore(gitops): promote ${OVERLAY} ${TAG}" || exit 0
          git push
